services:
  websocketplumber:
    build:
      context: ./WebSocketServer
      dockerfile: Dockerfile
    container_name: "WebSocketPlumber"
    env_file: 
      - ./WebSocketServer/.env
    ports: 
      - 3100:4500
    volumes:
      - ./WebSocketServer:/app
      - ws_node_modules:/app/node_modules
    depends_on:
      - neo4j
    command: ["node","index.js"]
    networks: [app]

  frontend:
    build:
      context: ./javisefront
      dockerfile: Dockerfile
    container_name: FrontEndNBP
    environment:
      - NODE_ENV=development
    ports:
      - 4050:4200
    volumes:
      - ./javisefront:/app
      - web_node_modules:/app/node_modules
    command: ["ng","serve","--host","0.0.0.0"]
    networks: [app]

  redis:
    image: redis:7
    container_name: majstori-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    networks: [app]
  neo4j:
    image: neo4j:5
    ports:
      - "7474:7474"   
      - "7687:7687"   
    env_file: 
      - ./WebSocketServer/.env
    volumes:
      - neo4j-data:/data
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p password123 'RETURN 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [app]

  backend:
    build:
      context: ./majstori-nbp-server
      dockerfile: Dockerfile
    ports:
      - "5104:5104"
    env_file:
      - ./majstori-nbp-server/.env
    depends_on:
      - redis
      - neo4j
    networks: [app]
  seeding:
    build:
      context: ./Seeding
      dockerfile: Dockerfile
    env_file:
      - ./Seeding/.env
    depends_on:
      neo4j:
        condition: service_healthy
    networks: [app]

networks:
  app:

volumes:
  web_node_modules:
  ws_node_modules:
  redis-data:
  neo4j-data:
